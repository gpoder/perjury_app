<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Perjury Control Panel</title>
  <link rel="stylesheet" href="{{ url_for('perjury.static', filename='perjury.css') }}">
</head>
<body>
  <h1>Perjury Control Panel</h1>
  <p><strong>IMPORTANT:</strong> Protect this endpoint using Nginx (IP allow, basic auth, VPN, etc.).</p>

  <h2>Settings</h2>
  <form method="post" action="{{ url_for('perjury.control_settings') }}">
    <p>
      <label>View duration (seconds)
        <input type="number" name="view_duration_seconds" value="{{ settings.view_duration_seconds }}">
      </label>
    </p>
    <p>
      <label>Global lockout (minutes)
        <input type="number" name="global_lockout_minutes" value="{{ settings.global_lockout_minutes }}">
      </label>
    </p>
    <p>
      <label>
        <input type="checkbox" name="enable_global_lockout" value="1"
               {% if settings.enable_global_lockout %}checked{% endif %}>
        Enable global lockout
      </label>
    </p>
    <p><button type="submit">Save Settings</button></p>
  </form>

  <h2>Generate Token</h2>
  <form method="post" action="{{ url_for('perjury.control_generate_token') }}">
    <p><label>Token value <input type="text" name="token" required></label></p>
    <p><label>PIN <input type="text" name="pin" required></label></p>
    <p><label>Image URL <input type="text" name="image_url" size="60" required></label></p>
    <p><button type="submit">Create Token</button></p>
  </form>

  <h2>Blocked IPs</h2>
  {% if blocks %}
    <ul>
      {% for ip in blocks %}
        <li>{{ ip }}</li>
      {% endfor %}
    </ul>
    <form method="post" action="{{ url_for('perjury.control_clear_blocks') }}">
      <button type="submit" onclick="return confirm('Clear all blocked IPs?');">Clear All Blocks</button>
    </form>
  {% else %}
    <p>No blocked IPs.</p>
  {% endif %}

  <h2>Tokens</h2>
  {% if tokens %}
    <table>
      <tr>
        <th>Token</th><th>PIN</th><th>Image</th><th>Used</th><th>IP</th><th>Created</th><th>Used At</th>
      </tr>
      {% for t in tokens %}
        <tr>
          <td><code>{{ t.token }}</code></td>
          <td>{{ t.pin }}</td>
          <td><a href="{{ t.image_url }}" target="_blank">image</a></td>
          <td>{{ 'yes' if t.used else 'no' }}</td>
          <td>{{ t.ip or '' }}</td>
          <td>{{ t.created_at or '' }}</td>
          <td>{{ t.used_at or '' }}</td>
        </tr>
      {% endfor %}
    </table>
  {% else %}
    <p>No tokens created yet.</p>
  {% endif %}
</body>
</html>
